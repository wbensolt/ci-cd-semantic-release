name: CI/CD Pipeline (single-job)

on:
  push:
    branches: [main, develop]

permissions:
  contents: write
  packages: write
  pull-requests: write
  id-token: write

jobs:
  ci:
    runs-on: ubuntu-latest
    concurrency: ci-${{ github.ref }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Sync tools
        run: uv sync --all-groups

      - name: Lint (ruff)
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Typecheck (mypy)
        run: uv run mypy app/

      - name: Security checks
        run: |
          uv run bandit -r app/ || true
          uv run safety check || true

      - name: Pre-commit
        uses: pre-commit/action@v3.0.0
        with:
          extra_args: "--all-files"

      - name: Run tests with coverage
        run: uv run pytest --cov=app --cov-report=term --cov-report=xml --cov-fail-under=60 tests/
