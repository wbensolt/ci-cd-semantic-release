# Nom du workflow qui apparaÃ®t dans l'interface GitHub Actions
name: Release

# DÃ©finit quand ce workflow doit s'exÃ©cuter
on:
    push:
        branches:
            - main
            - develop

# Permissions par dÃ©faut pour tous les jobs du workflow
permissions:
    contents: write      # CHANGÃ‰: read â†’ write (permet de crÃ©er des commits, tags)
    packages: write

jobs:
    release:
        name: Release
        runs-on: ubuntu-latest
        concurrency: release-${{ github.ref }}
        permissions:
            id-token: write
            contents: write      # ASSURÃ‰: write permissions
            packages: write
        outputs:
            version: ${{ steps.get_version.outputs.version }}
        steps:
            - name: Generate App Token
              id: get_token
              uses: actions/create-github-app-token@v2
              with:
                app-id: ${{ secrets.APP_ID }}
                private-key: ${{ secrets.PRIVATE_KEY }}

            - name: Checkout
              uses: actions/checkout@v5.0.0
              with:
                token: ${{ steps.get_token.outputs.token }}
                fetch-depth: 0

            - name: Checkout branch
              run: |
                BRANCH_NAME="${GITHUB_REF#refs/heads/}"
                echo "Checking out branch: $BRANCH_NAME"
                git checkout "$BRANCH_NAME"

            - name: astral-sh/setup-uv
              uses: astral-sh/setup-uv@v7.1.2
              with:
                version: "latest"

            - name: Install Python Semantic Release
              run: uv tool install python-semantic-release

            - name: Semantic Versioning
              id: semantic
              env:
                GITHUB_TOKEN: ${{ steps.get_token.outputs.token }}
                GH_TOKEN: ${{ steps.get_token.outputs.token }}
              run: |
                git config user.name "berryWIP-bot[bot]"
                git config user.email "berryWIP-bot[bot]@users.noreply.github.com"

                uv run semantic-release version --changelog

                if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                  echo "ðŸ“¦ Creating GitHub Release (main branch)"
                  uv run semantic-release publish
                else
                  echo "â­ï¸ Skipping GitHub Release (develop branch - pre-release only)"
                  git push --follow-tags origin HEAD
                fi

            - name: Get Version
              id: get_version
              run: |
                VERSION=$(git describe --tags --abbrev=0)
                echo "version=$VERSION" >> $GITHUB_OUTPUT

    build-and-push-docker:
        name: Build & Push Docker Image
        runs-on: ubuntu-latest
        needs: release
        if: github.ref == 'refs/heads/main'
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout
              uses: actions/checkout@v5.0.0
              with:
                fetch-depth: 0

            - name: Login to Docker Hub
              uses: docker/login-action@v3.6.0
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                images: ghcr.io/${{ github.repository }}
                tags: |
                  type=raw,value=${{ needs.release.outputs.version }}
                  type=raw,value=latest
                labels: |
                  org.opencontainers.image.version=${{ needs.release.outputs.version }}
                  org.opencontainers.image.revision=${{ github.sha }}

            - name: Build Docker image
              id: docker_build
              uses: docker/build-push-action@v5
              with:
                context: .
                file: Dockerfile
                push: false
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
                load: true

            - name: Scanner l'image avec Trivy
              uses: aquasecurity/trivy-action@master
              with:
                image-ref: ghcr.io/${{ github.repository }}:${{ needs.release.outputs.version }}
                format: "table"
                exit-code: "1"
                ignore-unfixed: true
                severity: "CRITICAL,HIGH"

            - name: Pousser l'image Docker
              uses: docker/build-push-action@v5
              with:
                context: .
                file: Dockerfile
                push: true
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
